---
- name: Install and configure tyk gateway
  hosts: "{{ variable_host }}"  
  become: true
  # vars_files:
  #   - vars/iim.yml
  #   - vars/ihs.yml
  # hosts: all
  # vars:
  #   helloworld: Meow!
  vars_files:
    - tyk-variables.yml
  

  tasks:
  - name: Add epel-release repo
    yum:
      name: epel-release
      state: present

  - name: Install packages
    yum:
        name:
          - python34
          - pygpgme
          - yum-utils
          - wget
        state: present

  - name: copy repo file
    template:
      src: templates/tyk_tyk-dashboard.repo
      dest: /etc/yum.repos.d/tyk_tyk-dashboard.repo

  - name: Run enable repo
    command: yum -q makecache -y --disablerepo='*' --enablerepo='tyk_tyk-dashboard' --enablerepo=epel
    register: configure_result
  - debug: var=configure_result

  - name: Install tyk-dashboard
    yum:
      name:
        - tyk-dashboard

  - name: Run setup
    command: /opt/tyk-dashboard/install/setup.sh --listenport="{{ gateway_port }}" --redishost=localhost --redisport=6379 --mongo=mongodb://localhost/tyk_analytics --tyk_api_hostname="{{ tyk_hostname }}" --tyk_node_hostname=http://localhost --tyk_node_port=8081 --portal_root=/portal --domain="{{ tyk_hostname }}"
    register: configure_result
  - debug: var=configure_result

  - name: enable dashboard
    systemd:
      name: tyk-dashboard
      state: started
      enabled: True
  
  - name: Add license key
    command: sed -i 's/"license_key": ""/"license_key": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhbGxvd2VkX25vZGVzIjoiZjE2OTI5MWMtNTFlOS00NGUzLTZkNmYtNmZjYTY2ZjEyMmI1IiwiZXhwIjoxNTY5OTgzNzAzLCJvd25lciI6IjVkMWQ2NWQ3NDVmOTJlMjE4ZGRkYWMzMiJ9.XPUepJOU152GdeBMII7cxgpT1xAF0Jmr2un4cMjEQ9517-53joqh02uu3Qq7lL0gt6Q5WYbWJ7Ipu2kBUvGnCermyV6b1HRnUXyk2L6jZXsS7vxDJRYPx6y3Tq1Noz3k1mVqjb3trRXsRMZZ_5QVLozKAT-T3-zEPZuJvbOOO_jQQOZ2G0en1t8KqH-OMd-EiCSQV4I5S2NBEjARTCZ30mznQP0BA6PirQooK1F9G0sHkdkNdGly11LhgIqfZw2VeX3Bp4RT_9RCemxdAIkN38Tb-ThYunVi0yKdMLdXOOnj9yCZjk2qBr3u5PKRM3nb4aKM48zlo_KXUxynb7ihTQ"/g' /opt/tyk-dashboard/tyk_analytics.conf
  
  - name: restart service tyk-dashboard
    systemd:
      state: restarted
      daemon_reload: yes
      name: tyk-dashboard

      